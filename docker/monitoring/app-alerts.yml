groups:
  - name: application_alerts
    interval: 30s
    rules:
      # Error Rate Alert
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          
      # Queue Depth Alert
      - alert: HighQueueDepth
        expr: medchain_job_queue_depth > 500
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "High job queue depth detected"
          description: "Queue {{ $labels.queue_name }} has {{ $value }} jobs pending (threshold: 500)"
          
      # Stellar RPC P95 Latency Alert
      - alert: HighStellarRPCLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(medchain_stellar_tx_duration_seconds_bucket[5m])) by (le, operation)
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: stellar
        annotations:
          summary: "High Stellar RPC latency detected"
          description: "P95 latency for {{ $labels.operation }} is {{ $value }}s (threshold: 2s)"
          
      # IPFS Upload Latency Alert
      - alert: HighIPFSUploadLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(medchain_ipfs_upload_duration_seconds_bucket[5m])) by (le)
          ) > 10
        for: 5m
        labels:
          severity: warning
          component: ipfs
        annotations:
          summary: "High IPFS upload latency detected"
          description: "P95 IPFS upload latency is {{ $value }}s (threshold: 10s)"
          
      # Application Down Alert
      - alert: ApplicationDown
        expr: up{job="medical-app"} == 0
        for: 1m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "Application is down"
          description: "The medical application has been down for more than 1 minute"
          
      # High Memory Usage Alert
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes{job="medical-app"}
            /
            (1024 * 1024 * 1024)
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High memory usage detected"
          description: "Application memory usage is {{ $value | humanize }}GB (threshold: 2GB)"
          
      # High CPU Usage Alert
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="medical-app"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High CPU usage detected"
          description: "Application CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"
          
      # FHIR API Error Rate Alert
      - alert: HighFHIRErrorRate
        expr: |
          (
            sum(rate(medchain_fhir_requests_total{status=~"error|failed"}[5m]))
            /
            sum(rate(medchain_fhir_requests_total[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          component: fhir
        annotations:
          summary: "High FHIR API error rate detected"
          description: "FHIR API error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          
      # No Records Uploaded Alert (potential issue)
      - alert: NoRecordsUploaded
        expr: |
          rate(medchain_records_uploaded_total[30m]) == 0
        for: 30m
        labels:
          severity: info
          component: records
        annotations:
          summary: "No records uploaded recently"
          description: "No medical records have been uploaded in the last 30 minutes"
          
      # High Access Grants Alert
      - alert: HighAccessGrants
        expr: medchain_access_grants_active > 10000
        for: 5m
        labels:
          severity: info
          component: access-control
        annotations:
          summary: "High number of active access grants"
          description: "Tenant {{ $labels.tenant }} has {{ $value }} active access grants (threshold: 10000)"
