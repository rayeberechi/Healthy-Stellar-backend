name: Translation Coverage Check

on:
  pull_request:
    paths:
      - 'src/i18n/locales/**'
      - 'src/email-templates/i18n/**'
      - '.github/workflows/i18n-coverage.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/i18n/locales/**'
      - 'src/email-templates/i18n/**'

jobs:
  translation-coverage:
    runs-on: ubuntu-latest
    
    name: Validate Translation Coverage
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Run translation coverage check
        run: |
          chmod +x scripts/check-translation-coverage.js
          node scripts/check-translation-coverage.js
        working-directory: ${{ github.workspace }}
      
      - name: Check translation completeness
        run: |
          # Verify all languages have the same number of keys
          EN_COUNT=$(jq 'paths | length' src/i18n/locales/en.json)
          FR_COUNT=$(jq 'paths | length' src/i18n/locales/fr.json)
          ES_COUNT=$(jq 'paths | length' src/i18n/locales/es.json)
          AR_COUNT=$(jq 'paths | length' src/i18n/locales/ar.json)
          
          echo "English: $EN_COUNT keys"
          echo "French: $FR_COUNT keys"
          echo "Spanish: $ES_COUNT keys"
          echo "Arabic: $AR_COUNT keys"
          
          if [ "$EN_COUNT" != "$FR_COUNT" ] || [ "$EN_COUNT" != "$ES_COUNT" ] || [ "$EN_COUNT" != "$AR_COUNT" ]; then
            echo "‚ùå Translation count mismatch!"
            exit 1
          fi
          
          echo "‚úÖ All languages have matching translation counts"
      
      - name: Verify email templates
        run: |
          # Check for all email template variants
          TEMPLATES=("access-granted" "verify-email" "reset-password")
          LANGUAGES=("en" "fr" "es" "ar")
          
          for template in "${TEMPLATES[@]}"; do
            for lang in "${LANGUAGES[@]}"; do
              FILE="src/email-templates/i18n/$template.$lang.hbs"
              if [ ! -f "$FILE" ]; then
                echo "‚ùå Missing email template: $FILE"
                exit 1
              fi
            done
          done
          
          echo "‚úÖ All email template variants present"
      
      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Count translation keys
            const en = JSON.parse(fs.readFileSync('src/i18n/locales/en.json', 'utf8'));
            const countKeys = (obj, path = '') => {
              let count = 0;
              for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'object' && value !== null) {
                  count += countKeys(value);
                } else {
                  count += 1;
                }
              }
              return count;
            };
            
            const keyCount = countKeys(en);
            
            const body = `
            ## üåç Translation Coverage Report
            
            ‚úÖ **All validation checks passed!**
            
            ### Statistics
            - **Total Translation Keys:** ${keyCount}
            - **Supported Languages:** en, fr, es, ar
            - **Coverage:** 100%
            
            ### Email Templates
            - ‚úÖ access-granted (4 variants)
            - ‚úÖ verify-email (4 variants)
            - ‚úÖ reset-password (4 variants)
            
            ### Key Sections
            - ‚úÖ common (16 keys)
            - ‚úÖ auth (24 keys)
            - ‚úÖ validation (12 keys)
            - ‚úÖ records (13 keys)
            - ‚úÖ access (13 keys)
            - ‚úÖ users (11 keys)
            - ‚úÖ errors (14 keys)
            - ‚úÖ email (11 keys)
            - ‚úÖ pagination (5 keys)
            - ‚úÖ status (9 keys)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-coverage-report
          path: |
            src/i18n/locales/
            src/email-templates/i18n/
          retention-days: 30

  lint-translations:
    runs-on: ubuntu-latest
    
    name: Lint Translation Files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate JSON syntax
        run: |
          for file in src/i18n/locales/*.json; do
            echo "Validating $file..."
            node -e "require('$file')" || { echo "‚ùå Invalid JSON in $file"; exit 1; }
          done
          echo "‚úÖ All translation files have valid JSON syntax"
      
      - name: Check for XSS patterns
        run: |
          # Check for potentially dangerous patterns in translations
          for file in src/i18n/locales/*.json; do
            if grep -q '<script\|javascript:\|onerror=\|onload=' "$file"; then
              echo "‚ùå Potential XSS pattern found in $file"
              exit 1
            fi
          done
          echo "‚úÖ No XSS patterns detected"
      
      - name: Check key naming consistency
        run: |
          # Extract all keys and check for naming consistency
          EN_KEYS=$(jq -r 'paths | join(".")' src/i18n/locales/en.json | sort)
          echo "Sample keys (first 10):"
          echo "$EN_KEYS" | head -10
          
          # Check that keys use snake_case or camelCase consistently
          if echo "$EN_KEYS" | grep -qE '[A-Z][a-z]+_[a-z]'; then
            echo "‚ö†Ô∏è  Mixed naming convention detected (some keys use underscores)"
          fi
          
          echo "‚úÖ Key naming validation complete"
